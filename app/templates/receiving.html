{% extends "base.html" %}

{% block content %}
<div class="container pb-5">
    <div class="row align-items-center mb-5">
        <div class="col-md-6">
            <a href="/"
                class="text-decoration-none text-muted fw-bold d-inline-flex align-items-center mb-3 group-link">
                <i class="bi bi-arrow-left me-2 transition-transform group-hover-translate-x"></i> Kembali ke Dashboard
            </a>
            <h2 class="fw-bold hero-title text-dark display-5">Penerimaan Barang</h2>
            <p class="text-muted lead fs-6">Input data barang masuk (Inbound) ke gudang Arcapada.</p>
        </div>
        <div class="col-md-6 text-end d-none d-md-block">
            <div class="d-inline-block rounded-circle bg-white shadow-sm p-4">
                <i class="bi bi-truck fs-1 text-gold"></i>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card border-0 shadow-lg rounded-5 glass-panel position-relative overflow-hidden">
                <!-- Decor Header Line -->
                <div class="position-absolute top-0 start-0 w-100"
                    style="height: 6px; background: linear-gradient(90deg, #1c1c1c, #b78628);"></div>

                <div class="card-body p-5">

                    <!-- PO Lookup Section -->
                    <div class="mb-5 p-4 rounded-4"
                        style="background-color: rgba(183, 134, 40, 0.05); border: 1px dashed #b78628;">
                        <h6 class="fw-bold text-dark mb-3"><i class="bi bi-robot me-2 text-gold"></i>Isi Otomatis dari
                            Purchase Order (PO)</h6>
                        <div class="input-group">
                            <input type="text" class="form-control border-0 shadow-sm" id="poSearchInput"
                                placeholder="Masukkan Nomor PO (contoh: PO-2023...)">
                            <button class="btn btn-warning text-white fw-bold px-4" type="button" onclick="searchPO()">
                                <i class="bi bi-search me-2"></i>Cari PO
                            </button>
                        </div>
                        <!-- PO Items Result -->
                        <div id="poItemsResult" class="mt-3" style="display: none;">
                            <div class="table-responsive rounded-3 bg-white shadow-sm p-2">
                                <table class="table table-hover mb-0 small">
                                    <thead class="bg-light">
                                        <tr>
                                            <th>Produk</th>
                                            <th>Dipesan</th>
                                            <th>Sisa</th>
                                            <th>Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="poItemsTableBody">
                                        <!-- Items will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <form action="{{ url_for('inventory.receiving_process') }}" method="POST">
                        <div class="row">
                            <div class="col-12 mb-4">
                                <h5 class="fw-bold text-dark border-bottom pb-3 mb-4"><i
                                        class="bi bi-file-earmark-text me-2 text-gold"></i>Informasi Dokumen</h5>
                            </div>
                        </div>

                        <div class="row g-4 mb-4">
                            <div class="col-md-6">
                                <div class="form-floating text-dark">
                                    <input type="text" class="form-control rounded-4 border-0 bg-light shadow-inner"
                                        id="ref" name="reference" placeholder="No. Surat Jalan" required>
                                    <label for="ref" class="text-muted fw-bold"><i class="bi bi-hash me-1"></i> No.
                                        Surat Jalan</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating text-dark">
                                    <input type="text" class="form-control rounded-4 border-0 bg-light shadow-inner"
                                        id="supplier" name="supplier" placeholder="Nama Supplier" required>
                                    <label for="supplier" class="text-muted fw-bold"><i class="bi bi-building me-1"></i>
                                        Supplier</label>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-5">
                            <div class="col-12 mb-4">
                                <h5 class="fw-bold text-dark border-bottom pb-3 mb-4"><i
                                        class="bi bi-box-seam me-2 text-gold"></i>Detail Barang</h5>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold small text-muted ms-1 mb-2">PILIH PRODUK</label>
                            <div class="input-group">
                                <span class="input-group-text bg-white border-0 rounded-start-4 ps-3 shadow-sm"><i
                                        class="bi bi-search text-gold"></i></span>
                                <select class="form-select border-0 shadow-sm py-3 pe-5 bg-white rounded-end-4"
                                    id="productSelect" name="product_id" style="min-height: 58px;" required>
                                    <option value="" disabled selected>-- Cari Kode SKU / Nama Barang --</option>
                                    {% for p in products %}
                                    <option value="{{ p.id }}">{{ p.sku }} - {{ p.name }} (Stok: {{ p.stock_quantity }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="row g-4 mb-4">
                            <div class="col-md-6">
                                <label class="form-label fw-bold small text-muted ms-1 mb-2">MODAL PER SATUAN
                                    (OPSIONAL)</label>
                                <div class="input-group shadow-sm rounded-4 overflow-hidden">
                                    <span class="input-group-text bg-white border-0 fw-bold text-gold px-3">Rp</span>
                                    <input type="number" class="form-control border-0 py-3" id="costInput" name="cost"
                                        placeholder="0" min="0" step="100">
                                </div>
                                <div class="form-text small ms-2 mt-1"><i class="bi bi-info-circle me-1"></i>Biarkan
                                    kosong untuk gunakan harga master data</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold small text-muted ms-1 mb-2">EXPIRY DATE</label>
                                <div class="input-group shadow-sm rounded-4 overflow-hidden">
                                    <span class="input-group-text bg-white border-0 px-3"><i
                                            class="bi bi-calendar text-gold"></i></span>
                                    <input type="date" class="form-control border-0 py-3" name="expiry_date">
                                </div>
                            </div>
                        </div>

                        <div class="mb-5">
                            <label class="form-label fw-bold small text-muted ms-1 mb-2">JUMLAH MASUK (QTY)</label>
                            <div
                                class="input-group shadow-lg rounded-pill overflow-hidden border border-2 border-light">
                                <button class="btn btn-light px-4 border-0" type="button"
                                    onclick="this.parentNode.querySelector('input[type=number]').stepDown()">
                                    <i class="bi bi-dash-lg"></i>
                                </button>
                                <input type="number"
                                    class="form-control border-0 text-center fw-bold fs-4 text-success bg-white"
                                    id="qtyInput" name="quantity" value="1" min="1" required>
                                <button class="btn btn-light px-4 border-0" type="button"
                                    onclick="this.parentNode.querySelector('input[type=number]').stepUp()">
                                    <i class="bi bi-plus-lg"></i>
                                </button>
                            </div>
                        </div>

                        <div class="d-grid mt-5">
                            <button type="submit"
                                class="btn btn-premium-gold rounded-pill py-3 fw-bold shadow-lg transform-hover">
                                <i class="bi bi-check-circle-fill me-2"></i> Konfirmasi Penerimaan Barang
                            </button>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .shadow-inner {
        box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
    }

    .text-gold {
        color: #b78628 !important;
    }

    .group-link:hover .group-hover-translate-x {
        transform: translateX(-5px);
    }

    .transition-transform {
        transition: transform 0.2s ease;
    }

    .transform-hover:hover {
        transform: translateY(-2px);
    }

    /* Enhance Select Dropdown */
    .form-select:focus {
        box-shadow: var(--shadow-soft);
        border-color: #b78628;
    }

    .form-floating>label {
        padding-left: 1.5rem;
    }

    .form-floating>.form-control {
        padding-left: 1.5rem;
    }
</style>

<script>
    async function searchPO() {
        const poNumber = document.getElementById('poSearchInput').value;
        if (!poNumber) {
            alert('Silakan masukkan nomor PO');
            return;
        }

        try {
            const response = await fetch(`/inventory/api/get_po_details?po_number=${encodeURIComponent(poNumber)}`);
            const data = await response.json();

            if (data.success) {
                // Fill Supplier
                document.getElementById('supplier').value = data.supplier;
                document.getElementById('ref').value = poNumber; // Set Reference default

                // Populate Items
                const tableBody = document.getElementById('poItemsTableBody');
                tableBody.innerHTML = '';

                data.items.forEach(item => {
                    const row = document.createElement('tr');

                    // Use a more robust way to pass object data. We encode it to base64 or just use data attributes?
                    // Simple JSON stringify in onclick works if no quotes.
                    // Safer: bind click listener dynamically or store in global map.
                    // For now, simpler: data-attributes.

                    row.innerHTML = `
                        <td><div class="fw-bold">${item.name}</div><small class="text-muted">${item.sku}</small></td>
                        <td>${item.ordered_qty}</td>
                        <td class="text-primary fw-bold">${item.remaining_qty}</td>
                        <td><button type="button" class="btn btn-sm btn-outline-primary select-po-item-btn" 
                            data-product-id="${item.product_id}" 
                            data-qty="${item.remaining_qty}" 
                            data-cost="${item.unit_cost}">Pilih</button></td>
                    `;
                    tableBody.appendChild(row);
                });

                // Add listeners
                document.querySelectorAll('.select-po-item-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const pid = this.getAttribute('data-product-id');
                        const qty = this.getAttribute('data-qty');
                        const cost = this.getAttribute('data-cost');

                        document.getElementById('productSelect').value = pid;
                        document.getElementById('qtyInput').value = qty;
                        if (cost && cost !== 'null') document.getElementById('costInput').value = cost;

                        // Focus
                        document.getElementById('productSelect').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    });
                });

                document.getElementById('poItemsResult').style.display = 'block';
            } else {
                alert(data.message || 'PO tidak ditemukan');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Terjadi kesalahan saat mengambil data PO');
        }
    }
</script>
{% endblock %}