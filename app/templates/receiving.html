{% extends "base.html" %}

{% block content %}
<div class="container pb-5">
    <div class="row align-items-center mb-5">
        <div class="col-md-6">
            <a href="/"
                class="text-decoration-none text-muted fw-bold d-inline-flex align-items-center mb-3 group-link">
                <i class="bi bi-arrow-left me-2 transition-transform group-hover-translate-x"></i> Kembali ke Dashboard
            </a>
            <h2 class="fw-bold hero-title text-dark display-5">Penerimaan Barang</h2>
            <p class="text-muted lead fs-6">Input data barang masuk (Inbound) ke gudang Arcapada.</p>
        </div>
        <div class="col-md-6 text-end d-none d-md-block">
            <div class="d-inline-block rounded-circle bg-white shadow-sm p-4">
                <i class="bi bi-truck fs-1 text-gold"></i>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-10"> <!-- Widened to accommodate table -->
            <div class="card border-0 shadow-lg rounded-5 glass-panel position-relative overflow-hidden">
                <!-- Decor Header Line -->
                <div class="position-absolute top-0 start-0 w-100"
                    style="height: 6px; background: linear-gradient(90deg, #1c1c1c, #b78628);"></div>

                <div class="card-body p-5">

                    <!-- PO Lookup Section -->
                    <div class="mb-5 p-4 rounded-4"
                        style="background-color: rgba(183, 134, 40, 0.05); border: 1px dashed #b78628;">
                        <h6 class="fw-bold text-dark mb-3"><i class="bi bi-robot me-2 text-gold"></i>Isi Otomatis dari
                            Purchase Order (PO)</h6>
                        <div class="input-group">
                            <input type="text" class="form-control border-0 shadow-sm" id="poSearchInput"
                                placeholder="Masukkan Nomor PO (contoh: PO-2023...)">
                            <button class="btn btn-warning text-white fw-bold px-4" type="button" onclick="searchPO()">
                                <i class="bi bi-search me-2"></i>Cari PO
                            </button>
                        </div>
                        <!-- PO Items Result -->
                        <div id="poItemsResult" class="mt-3" style="display: none;">
                            <div class="alert alert-info border-0 shadow-sm mb-0">
                                <small><i class="bi bi-info-circle me-1"></i>Klik tombol <b>Pilih</b> di bawah untuk
                                    menambahkan item ke daftar terima.</small>
                            </div>
                            <div class="table-responsive rounded-3 bg-white shadow-sm mt-2">
                                <table class="table table-hover mb-0 small">
                                    <thead class="bg-light">
                                        <tr>
                                            <th>Produk</th>
                                            <th>Dipesan</th>
                                            <th>Sisa</th>
                                            <th>Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="poItemsTableBody">
                                        <!-- Items will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <form action="{{ url_for('inventory.receiving_process') }}" method="POST" id="receiveForm">
                        <div class="row">
                            <div class="col-12 mb-4">
                                <h5 class="fw-bold text-dark border-bottom pb-3 mb-4"><i
                                        class="bi bi-file-earmark-text me-2 text-gold"></i>Informasi Dokumen</h5>
                            </div>
                        </div>

                        <div class="row g-4 mb-4">
                            <div class="col-md-6">
                                <div class="form-floating text-dark">
                                    <input type="text" class="form-control rounded-4 border-0 bg-light shadow-inner"
                                        id="ref" name="reference" placeholder="No. Surat Jalan" required>
                                    <label for="ref" class="text-muted fw-bold"><i class="bi bi-hash me-1"></i> No.
                                        Surat Jalan</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating text-dark">
                                    <input type="text" class="form-control rounded-4 border-0 bg-light shadow-inner"
                                        id="supplier" name="supplier" placeholder="Nama Supplier" required>
                                    <label for="supplier" class="text-muted fw-bold"><i class="bi bi-building me-1"></i>
                                        Supplier</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-floating text-dark">
                                    <textarea class="form-control rounded-4 border-0 bg-light shadow-inner"
                                        name="print_address" placeholder="Alamat Cetak"
                                        style="height: 100px;"></textarea>
                                    <label class="text-muted fw-bold"><i class="bi bi-geo-alt me-1"></i> Alamat Cetak /
                                        Catatan (Opsional)</label>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-5">
                            <div class="col-12 mb-4">
                                <h5 class="fw-bold text-dark border-bottom pb-3 mb-4"><i
                                        class="bi bi-box-seam me-2 text-gold"></i>Detail Barang</h5>
                            </div>
                        </div>

                        <!-- Manual Add Item Box -->
                        <div class="bg-light bg-opacity-50 p-4 rounded-4 mb-4 border border-light shadow-sm">
                            <h6 class="text-muted text-uppercase fw-bold small mb-3">Tambah Item Manual</h6>
                            <div class="row g-3 items-end">
                                <div class="col-md-5">
                                    <label class="form-label small text-muted">Produk</label>
                                    <select class="form-select border-0 shadow-sm" id="productSelect">
                                        <option value="">-- Pilih Produk --</option>
                                        {% for p in products %}
                                        <option value="{{ p.id }}" data-sku="{{ p.sku }}" data-name="{{ p.name }}"
                                            data-cost="{{ p.cost }}">{{ p.sku }} - {{ p.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small text-muted">Jumlah</label>
                                    <input type="number" class="form-control border-0 shadow-sm" id="qtyInput" value="1"
                                        min="1">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small text-muted">Cost (Opt)</label>
                                    <input type="number" class="form-control border-0 shadow-sm" id="costInput"
                                        placeholder="Auto">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small text-muted d-block">&nbsp;</label>
                                    <button type="button" class="btn btn-dark w-100 shadow-sm"
                                        onclick="addManualItem()">
                                        <i class="bi bi-plus-lg"></i> Tambah
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Received Items Table -->
                        <div class="table-responsive rounded-4 bg-white shadow-sm overflow-hidden mb-4">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light small text-muted text-uppercase">
                                    <tr>
                                        <th class="ps-4 py-3">Produk</th>
                                        <th class="py-3 text-center">Jumlah</th>
                                        <th class="py-3 text-end">Cost</th>
                                        <th class="py-3 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="receivedItemsBody">
                                    <tr id="emptyStateRow">
                                        <td colspan="4" class="text-center py-5 text-muted">
                                            <i class="bi bi-box-seam fs-1 d-block mb-2 opacity-25"></i>
                                            Belum ada item ditambahkan.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <input type="hidden" name="items_json" id="itemsJson">

                        <div class="d-grid mt-5">
                            <button type="submit"
                                class="btn btn-premium-gold rounded-pill py-3 fw-bold shadow-lg transform-hover"
                                onclick="submitForm(event)">
                                <i class="bi bi-check-circle-fill me-2"></i> Konfirmasi Penerimaan Barang
                            </button>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .shadow-inner {
        box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
    }

    .text-gold {
        color: #b78628 !important;
    }

    .group-link:hover .group-hover-translate-x {
        transform: translateX(-5px);
    }

    .transition-transform {
        transition: transform 0.2s ease;
    }

    .transform-hover:hover {
        transform: translateY(-2px);
    }

    .form-select:focus,
    .form-control:focus {
        box-shadow: var(--shadow-soft);
        border-color: #b78628;
    }

    .form-floating>label {
        padding-left: 1.5rem;
    }

    .form-floating>.form-control {
        padding-left: 1.5rem;
    }
</style>

<script>
    let receivedItems = [];

    async function searchPO() {
        const poNumber = document.getElementById('poSearchInput').value;
        if (!poNumber) return alert('Silakan masukkan nomor PO');

        try {
            const response = await fetch(`/inventory/api/get_po_details?po_number=${encodeURIComponent(poNumber)}`);
            const data = await response.json();

            if (data.success) {
                document.getElementById('supplier').value = data.supplier;
                document.getElementById('ref').value = poNumber;

                const tableBody = document.getElementById('poItemsTableBody');
                tableBody.innerHTML = '';

                if (data.items.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Semua item di PO ini sudah diterima penuh.</td></tr>';
                }

                data.items.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><div class="fw-bold">${item.name}</div><small class="text-muted">${item.sku}</small></td>
                        <td>${item.ordered_qty}</td>
                        <td class="text-primary fw-bold">${item.remaining_qty}</td>
                        <td><button type="button" class="btn btn-sm btn-outline-primary" 
                            onclick="addItemFromPO('${item.product_id}', '${item.name}', '${item.sku}', ${item.remaining_qty}, ${item.unit_cost})">
                            Pilih
                        </button></td>
                    `;
                    tableBody.appendChild(row);
                });
                document.getElementById('poItemsResult').style.display = 'block';
            } else {
                alert(data.message || 'PO tidak ditemukan');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Terjadi kesalahan saat mengambil data PO');
        }
    }

    function addManualItem() {
        const select = document.getElementById('productSelect');
        const pId = select.value;
        const qty = parseInt(document.getElementById('qtyInput').value);
        const costVal = document.getElementById('costInput').value;

        if (!pId) return alert('Pilih produk dulu!');
        if (qty < 1) return alert('Jumlah minimal 1');

        const option = select.options[select.selectedIndex];
        // Use manual cost or fallback to data-cost
        const cost = costVal ? parseFloat(costVal) : parseFloat(option.getAttribute('data-cost') || 0);

        addItem(pId, option.getAttribute('data-name'), option.getAttribute('data-sku'), qty, cost);

        // Reset manual inputs
        select.value = "";
        document.getElementById('qtyInput').value = 1;
        document.getElementById('costInput').value = "";
    }

    function addItemFromPO(id, name, sku, qty, cost) {
        addItem(id, name, sku, qty, cost);
        // Maybe visual feedback or disable button?
    }

    function addItem(id, name, sku, qty, cost) {
        // Check if exists
        const existing = receivedItems.find(i => i.product_id == id);
        if (existing) {
            existing.quantity += qty;
            // Optionally update cost logic? Keep old cost or average? For now assume same.
        } else {
            receivedItems.push({
                product_id: id,
                name: name,
                sku: sku,
                quantity: qty,
                cost: cost
            });
        }
        renderTable();
    }

    function removeItem(index) {
        receivedItems.splice(index, 1);
        renderTable();
    }

    function renderTable() {
        const tbody = document.getElementById('receivedItemsBody');
        tbody.innerHTML = '';

        if (receivedItems.length === 0) {
            tbody.innerHTML = `<tr id="emptyStateRow"><td colspan="4" class="text-center py-5 text-muted"><i class="bi bi-box-seam fs-1 d-block mb-2 opacity-25"></i>Belum ada item ditambahkan.</td></tr>`;
            return;
        }

        receivedItems.forEach((item, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="ps-4">
                    <div class="fw-bold text-dark">${item.name}</div>
                    <small class="text-muted">${item.sku}</small>
                </td>
                <td class="text-center">
                    <div class="input-group input-group-sm justify-content-center" style="width: 120px; margin: 0 auto;">
                        <input type="number" class="form-control text-center" value="${item.quantity}" min="1" 
                            onchange="updateItemQty(${index}, this.value)">
                    </div>
                </td>
                <td class="text-end font-monospace">Rp ${item.cost ? item.cost.toLocaleString() : '-'}</td>
                <td class="text-center">
                    <button type="button" class="btn btn-sm btn-light text-danger rounded-circle" onclick="removeItem(${index})">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function updateItemQty(index, val) {
        if (val < 1) return;
        receivedItems[index].quantity = parseInt(val);
    }

    function submitForm(e) {
        if (receivedItems.length === 0) {
            e.preventDefault();
            alert('Mohon tambahkan minimal satu barang!');
            return;
        }
        document.getElementById('itemsJson').value = JSON.stringify(receivedItems);
    }
</script>
{% endblock %}